<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <!-- This example requires Tailwind CSS v2.0+ -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6 flex flex-col">

            <div class="min-h-full flex flex-col justify-center py-12 sm:px-6 lg:px-8">
                <div class="sm:mx-auto sm:w-full sm:max-w-4xl">
                    <img class="mx-auto" src="dvn.jpg" alt="DVN">
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Generate Pre-signed Offline
                        Auto-compound Transactions</h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        for your Moonbeam delegation to the Diversified Validator Network
                    </p>
                    <p class="pt-6">Your key is used to sign the transactions locally. For peace-of-mind, you should 1)
                        load the app in Chrome, Incognito mode, 2) close your internet connection,
                        3) enter your private key, 4) generate the offline transactions and copy them, and 4) close your
                        browser, <u>before</u> turning your internet back on. Only use this app if you trust
                        StakeGlmr.com | DVN and/or can read the <a
                            href="https://github.com/diversified-validator-network/diversified-validator-network.github.io"
                            target="_black" class="font-bold">Github code</a>, or trust somebody else who can.
                        This app is a live Github repo so that anyone can check when was the last date the app was
                        modified and what changed.
                    </p>
                </div>

                <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-lg">
                    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                        <div class="space-y-6" action="#" method="POST">

                            <!--<div>
                                <label for="address" class="block text-sm font-medium text-gray-700"> My Moonbeam
                                    address* </label>
                                <div class="mt-1">
                                    <input autocomplete="off" value="" id="address" name="address" type="text" required
                                        class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>-->

                            <div>
                                <label for="key" class="block text-sm font-medium text-gray-700"> Private key* </label>
                                <div class="mt-1">
                                    <input autocomplete="off" value="" id="key" name="key" type="text" required
                                        class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>

                            <div class="flex justify-between">
                                <div class="mr-1">
                                    <label for="delegation" value="" class=" block text-sm font-medium text-gray-700">
                                        Delegation to DVN</label>
                                    <div class="mt-1">
                                        <input autocomplete="off" id="delegation" name="delegation" type="number"
                                            required placeholder="GLMR"
                                            class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                                <div class="ml-1 w-full">
                                    <label for="txcount" value="" class="block text-sm font-medium text-gray-700">
                                        Number of
                                        TXs to generate* </label>
                                    <div class="mt-1">
                                        <input autocomplete="off" id="txcount" name="txcount" type="number" required
                                            class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div class="text-sm h-3 text-right">
                                        <span id="recomendedPeriods"></span>
                                    </div>
                                </div>

                            </div>

                            <div class="ml-1 w-full font-bold text-center text-red-500" id="error">

                            </div>

                            <div>
                                <button onclick="signTx()"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Generate
                                    Offline Transactions</button>
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500"> ATTENTION </span>
                                </div>
                            </div>
                            <div class="pt-2">
                                You should almost NEVER enter your private key on a form like this.
                                Before using this service make sure you watch this video to fully understand what you
                                are doing.
                            </div>

                            <div class="mt-6 hidden" id="commentBox">
                                <label for="comment" class="block text-sm font-medium text-gray-700">Right-click, select
                                    all, and copy the transactions</label>
                                <label for="comment" class="block text-sm font-medium text-gray-700">Go to stakeglmr.com
                                    and paste into the Auto-compound TX field</label>
                                <div class="mt-1">
                                    <textarea rows="4" name="comment" id="comment"
                                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.4/ethers.umd.min.js"
        integrity="sha512-xmbPx0riylir51GhTZCFd20yS7NYZNpfDTbEWBjDRzs+UaGb2RyjtASTVtF2ydQWp3xkso9j4sJj39PdSH8/EA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script type="text/javascript" src="staking_abi.js"></script>

    <!-- TRANSACTION GENERATION SCRIPT-->
    <script>

        const rp = {
            delegations: [500, 1000, 2000, 3000, 4000, 5000, 10000, 20000, 40000, 50000, 100000],
            periods: [48, 68, 98, 120, 139, 155, 220, 312, 442, 494, 699]
        }
        const stakingPrecompileAddress = '0x0000000000000000000000000000000000000800'
        const collatorAccount = '0x62Ec573d52ECc9cDD6ed93C00a2F85Bc657878B3' // DVN collator account
        const longtermAPR = 22

        const providerURL = "https://rpc.api.moonbeam.network";
        // Define Provider
        const provider = new ethers.providers.StaticJsonRpcProvider(providerURL, {
            chainId: 1284,
            name: 'moonbeam'
        });

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const from = urlParams.get('me')
        if (!isAddress(from)) {
            document.getElementById('error').textContent = 'Not a valid Moonbeam address'
        }

        let nonce
        (async () => {
            nonce = await provider.getTransactionCount(from)
            console.log('Current nonce is ' + nonce)
        })()

        async function signTx() {

            document.getElementById('error').textContent = ''
            // const from = document.getElementById("address").value
            const delegationValue = document.getElementById("delegation").value
            const txCountValue = document.getElementById("txcount").value
            const privateKey = document.getElementById("key").value

            if (!privateKey || privateKey.length < 20) {
                document.getElementById('error').textContent = 'Private key is not valid'
                return
            }
            if (!delegationValue || +delegationValue < 300) {
                document.getElementById('error').textContent = 'Minimum delegation is 300'
                return
            }
            if (!txCountValue || +txCountValue < 5 || +txCountValue > 200) {
                document.getElementById('error').textContent = 'Minimum transaction count is 5 and maximum is 200'
                return
            }

            const stakingContract = new ethers.Contract(
                stakingPrecompileAddress, // contract address
                stakingABI, // ABI file
                provider
            );
            const amount = Math.round(
                1000000 * (1 / Math.min(calculateRecommendedPeriod(delegationValue)*2, 365)) * (+delegationValue) * longtermAPR / 100
            ) + '00000000000'
            console.log('amount', amount)
            const txData = await stakingContract.populateTransaction
                .delegator_bond_more(collatorAccount, amount);
            console.log('txData', txData)

            const txCount = +txCountValue
            const txs = []

            for (let txCounter = 0; txCounter < +txCount; txCounter++) {
                const transaction = {
                    ...txData,
                    to: stakingPrecompileAddress,
                    nonce: ethers.utils.hexlify(+nonce + +txCounter),
                    value: '0x00',
                    gasPrice: 100000000000,
                    gasLimit: 61378,
                }
                console.log('transaction', transaction)

                let wallet = new ethers.Wallet(privateKey, provider);
                let rawTransaction = await wallet.signTransaction(transaction).then(ethers.utils.serializeTransaction(transaction));
                console.log('Raw txhash string ' + rawTransaction);
                txs.push({
                    nonce: nonce + txCounter,
                    collator: collatorAccount,
                    rawTransaction,
                    amount
                })
            }
            document.getElementById('comment').value = JSON.stringify({
                address: from,
                transactions: txs
            });
            document.getElementById('commentBox').classList.remove("hidden");
            // await provider.sendTransaction(rawTransaction);
            // console.log('Submitted tx', rawTransaction)
        }

        function isAddress(address) {
            try {
                ethers.utils.getAddress(address)
                return true
            } catch {
                return false
            }
        }

        function isPrivateKey(pk) {
            try {
                const w = new ethers.Wallet(pk)
                return true
            } catch {
                return false
            }
        }

        function calculateRecommendedPeriod(delegation) {
            for (let i = 1; i < rp.delegations.length; i++) {
                if (delegation < rp.delegations[i] && delegation >= rp.delegations[i - 1]) {
                    return Math.round(1 / 2 * (rp.delegations[i] * rp.periods[i] + rp.delegations[i - 1] * rp.periods[i - 1]) / (rp.delegations[i] + rp.delegations[i - 1]))
                }
            }
            return undefined
        }

        document.getElementById("delegation").addEventListener('input', function (evt) {
            const recomendedPeriods = calculateRecommendedPeriod(document.getElementById("delegation").value)
            document.getElementById("recomendedPeriods").textContent = recomendedPeriods ? recomendedPeriods + ' txs will last about 6 months.' : '';
        });
    </script>

</body>

</html>